
/*BODEGA*/

CREATE TABLE IF NOT EXISTS bodega.producto
(
    id integer NOT NULL DEFAULT nextval('bodega."Producto_id_seq"'::regclass),
    codigo_producto character(30) COLLATE pg_catalog."default" NOT NULL,
    nombre character(10) COLLATE pg_catalog."default" NOT NULL,
    descrpcion character(250) COLLATE pg_catalog."default" NOT NULL,
    precio money NOT NULL,
    CONSTRAINT "Producto_pkey" PRIMARY KEY (id)
);


create table bodega.consola(
 marca character(72) not null,
 modelo character(72) not null)
 /*hereda de producto*/
 inherits ( bodega.producto );


create table bodega.videojuego(
 genero Character(50) not null,
 ano_lanzamiento date not null,
 plataforma Character(72) not null,
 mecanica Character(72) not null)
 inherits (bodega.producto);

/*ejemplo de un insert para consola*/
INSERT INTO bodega.consola (codigo_producto, nombre, descrpcion, precio,categoria ,marca, modelo) VALUES
('C001', 'PlayStation 5', 'Consola de videojuegos PlayStation 5', '499.99',1,'Sony', 'PlayStation 5');

/*ejemplo de un insert para videojuego*/
INSERT INTO bodega.videojuego (codigo_producto, nombre, descrpcion, precio,categoria ,genero, ano_lanzamiento, plataforma, mecanica) VALUES
('V001', 'The Last of Us Part II', 'Juego de acción y aventura', '59.99',2,'Acción', '2020-06-19', 'PlayStation 4', 'Supervivencia');



CREATE TABLE IF NOT EXISTS bodega.bodega
(
    id integer NOT NULL DEFAULT nextval('bodega."Producto_id_seq"'::regclass),
	id_empleado bigint NOT NULL,
    id_sucursal bigint NOT NULL,
    CONSTRAINT "bodega_pkey" PRIMARY KEY (id),
    CONSTRAINT "fk_sucursal" FOREIGN KEY (id_sucursal) REFERENCES sucursal.sucursal(id_sucursal),
	CONSTRAINT  "fk_empleado" FOREIgn key (id_empleado) REFERENCES administrador.empleado(id_empleado)
   
);


CREATE TABLE IF NOT EXISTS bodega.producto_bodega(
 id_producto_bodega serial Not NULL,
 id_bodega integer NOT NULL,
 id_producto integer NOT NULL,
 cantidad int NOT NULL,
 CONSTRAINT "producto_bodega_pkey" PRIMARY KEY (id_producto_bodega),
 CONSTRAINT "fk_producto" FOREIGN KEY (id_producto) REFERENCES bodega.producto(id),
 CONSTRAINT "fk_bodega" FOREIGN KEY (id_bodega) REFERENCES bodega.bodega(id)
);

/*Administrador*/

CREATE TABLE IF NOT EXISTS administrador.empleado
(
    id_empleado integer NOT NULL DEFAULT nextval('administrador.empleado_id_empleado_seq'::regclass),
    rol char,
	usuario Character(75) UNIQUE NOT NULL ,
	contrasena password NOT NULL,
	id_sucursal bigint NOT NULL,
	nombre Character(75) NOt NULL,
	telefono numeric(8) NOT  NULL,
	correo Character(20) NOT NULL,
	CHECK (correo ~'@'),
	CONSTRAINT empleado_pkey PRIMARY KEY (id_empleado)
)



/*SUCURSAL*/
CREATE TABLE IF NOT EXISTS sucursal.sucursal
(   
    id_sucursal integer NOT NULL DEFAULT nextval('sucursal.sucursal_id_sucursal_seq'::regclass),
    direccion character(150) COLLATE pg_catalog."default" NOT NULL,
    nombre character(72) COLLATE pg_catalog."default" NOT NULL,
    no_sucursal integer NOT NULL,
    CONSTRAINT sucursal_pkey PRIMARY KEY (id_sucursal)
)

/*INVENTARIO*/

CREATE TABLE inventario.estanteria(
	id_estanteria serial NOT NULL,
	id_sucursal integer NOT NULL,
	id_empleado integer NOT NULL,
	CONSTRAINT estateria_pkey PRIMARY KEY (id_estanteria),
	CONSTRAINT "fk_sucursal" FOREIGN KEY (id_sucursal) REFERENCES sucursal.sucursal(id_sucursal),
	CONSTRAINT "fk_empleado" FOREIGN KEY (id_empleado) REFERENCES bodega.bodega(id)
	
);


CREATE TABLE inventario.estanteria_producto(
	id_estanteria_producto serial Not NULL,
	id_estanteria integer NOT NULL,
	id_producto_bodega integer NOT NULL,
	no_pasillo Character(50),
	CONSTRAINT estateria_producto_pkey PRIMARY KEY (id_estanteria_producto),
	CONSTRAINT "fk_estanteria" FOREIGN KEY (id_estanteria) REFERENCES inventario.estanteria(id_estanteria),
	CONSTRAINT "fk_producto_bodega" FOREIGN KEY (id_producto_bodega) REFERENCES bodega.producto_bodega(id_producto_bodega)
);


 /* procedimiento para ingresar un usuario*/
CREATE OR REPLACE PROCEDURE administrador.registrar_empleado(
    rol VARCHAR(10),
    usuario VARCHAR(75),
    contrasena TEXT,
    id_sucursal BIGINT,
    nombre VARCHAR(75),
    telefono NUMERIC(8),
    correo VARCHAR(20),
    no_caja INT
)
LANGUAGE plpgsql
AS $$
BEGIN
    IF no_caja IS NULL THEN
        -- si el numero de caja es nulo se inserta en empleado   
		 INSERT INTO administrador.empleado (rol, usuario, contrasena, id_sucursal, nombre, telefono, correo)
        VALUES (rol, usuario, contrasena, id_sucursal, nombre, telefono, correo);
		
    ELSE
        INSERT INTO administrador.cajero (rol, usuario, contrasena, id_sucursal, nombre, telefono, correo,no_caja)
        VALUES (rol, usuario, contrasena, id_sucursal, nombre, telefono, correo,no_caja);
    END IF;
END;
$$;


/*inserte de un empleado*/
CALL  administrador.registrar_empleado(
'B','LuisBodega1','123456',1,'Gerardo',77668945,'luis@gmail.com',null);


/*inserte de un cajero*/
CALL  administrador.registrar_empleado('C','Cajero1','123456',1,'cajero',77668945,'cajero@gmail.com',1);

/* Funcion  login  */

CREATE OR REPLACE FUNCTION administrador.login(p_correo VARCHAR(256), p_contrasena TEXT)
RETURNS TABLE(id_empleado BIGINT, id_sucursal BIGINT, rol CHAR, dato INTEGER) AS $$
DECLARE
    rol_empleado CHAR;
BEGIN
    -- Obtener el rol del empleado basado en correo y contraseña
    SELECT e.rol INTO rol_empleado
    FROM administrador.empleado e
    WHERE e.correo = p_correo AND e.contrasena = p_contrasena;

    -- Verificar el rol y retornar datos diferentes según el rol
    IF rol_empleado = 'B' THEN
        RETURN QUERY
        SELECT b.id_empleado, b.id_sucursal, e.rol, b.id_bodega  
        FROM bodega.bodega b
        LEFT JOIN administrador.empleado e ON b.id_empleado = e.id_empleado;

    ELSIF rol_empleado = 'I' THEN
        RETURN QUERY
        SELECT   i.id_empleado, i.id_sucursal, e.rol,  i.id_estanteria 
        FROM inventario.estanteria i
        LEFT JOIN administrador.empleado e ON i.id_empleado = e.id_empleado;

    ELSIF rol_empleado = 'C' THEN
        RETURN QUERY
        SELECT c.id_empleado, c.id_sucursal, c.rol, c.no_caja 
        FROM administrador.cajero c;

    ELSIF rol_empleado = 'A' THEN
        RETURN QUERY
        SELECT a.id_empleado, a.id_sucursal, a.rol,NULL::INTEGER
        FROM administrador.empleado a;

    ELSE
        RETURN QUERY
        SELECT NULL::TEXT AS id_empleado, NULL::TEXT AS id_sucursal, NULL::TEXT AS rol, 'Rol desconocido' AS datos;
    END IF;
END;
$$ LANGUAGE plpgsql;




 CREATE OR REPLACE PROCEDURE bodega.obtener_producto(p_id_producto BIGINT)
LANGUAGE plpgsql
AS $$
DECLARE
    categoria integer;
	v_result RECORD;
BEGIN 

	SELECT p.categoria INTO categoria
    FROM bodega.producto p
    WHERE p.id_producto = p_id_producto; 

 IF categoria = 1 THEN
        -- Consultar y devolver información de consola
        FOR v_result IN
            SELECT * FROM bodega.consola
            WHERE id_producto = p_id_producto
        LOOP
            RAISE NOTICE 'Consola: %', v_result;
        END LOOP;
    ELSE
        -- Consultar y devolver información de videojuego
        FOR v_result IN
            SELECT * FROM bodega.videojuego
            WHERE id_producto = p_id_producto
        LOOP
            RAISE NOTICE 'Videojuego: %', v_result;
        END LOOP;
    END IF;
END;
$$;


CREATE VIEW